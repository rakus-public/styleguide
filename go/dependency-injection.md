# Dependency Injection

## 目次

1. このページの概要
2. Dependency Injection(DI)とは
3. Constructor Injection の例と実装上の課題
4. `google/wire` を用いた DI の実現方法

## 1.このページの概要

- レイヤードアーキテクチャで`userinterface`層の struct を初期化する際、フィールドに持つインスタンスの初期化も大量に行う必要がありコード量も増える
- Constructor Injection を簡略化するための DI 補助ツールである`google/wire`を用いて、`userinterface`層の struct の初期化関数を自動生成する方法を記載する

## 2.Dependency Injection(DI)とは

- [Wikipedia](https://ja.wikipedia.org/wiki/%E4%BE%9D%E5%AD%98%E6%80%A7%E3%81%AE%E6%B3%A8%E5%85%A5)より

```text
依存性の注入（いぞんせいのちゅうにゅう、英: Dependency injection）とは、
あるオブジェクトや関数が、依存する他のオブジェクトや関数を受け取るデザインパターンである。
英語の頭文字からDIと略される。

(中略)

DIを利用したプログラムを作成する場合、コンポーネント間の関係はインタフェースを用いて記述し、
具体的なコンポーネントを指定しない。

具体的にどのコンポーネントを利用するかは別のコンポーネントや外部ファイル等を利用することで、
コンポーネント間の依存関係を薄くすることができる。
```

### DI の種類

#### Constructor Injection

コンポーネントの初期化関数(コンストラクタ)の引数に依存するコンポーネントを渡す

```go
func main() {
    // Constructor Injection
    u := NewUser("12345", "Taro")

    fmt.Printf("User: %+v", u)
}

type User struct {
    ID   string
    Name string
}

func NewUser(id string, name string) *User {
  return &User{
    ID:   id
    Name: name
  }
}
```

#### Setter Injection

依存するコンポーネントのフィールドへの Setter 関数を定義する

```go
func main() {
    // Setter Injection
    u := new(User)
    u.SetID("12345")
    u.SetName("Taro")

    fmt.Printf("User: %+v", u)
}

type User struct {
    ID   string
    Name string
}

func (u *User) SetID(id string) {
    u.ID = id
}

func (u *User) SetName(name string) {
    u.Name = name
}
```

#### Field Inejction

依存するコンポーネントのフィールドへ利用するコンポーネントを直接渡す

```go
func main() {
    // Field Injection
    u := new(User)
    u.ID = "12345"
    u.Name = "Taro"

    fmt.Printf("User: %+v", u)
}

type User struct {
    ID   string
    Name string
}
```

## 3.Constructor Injection の例と実装上の課題

### AuthController 初期化関数作成

- [認証 API のサンプルコード](./auth-api-sample-code.md)の`AuthController`を初期化する`InitializeAuthController`関数を作成する
  - 必要なインスタンスをファクトリ関数(「New〜」)を使って組み立てる Constructor Injection で実現する

```go
package injection

import (
    "authentication/application"
    "authentication/domain"
    "authentication/infrastructure"
    "authentication/userinterface"
)

func InitializeAuthController() *userinterface.AuthController {
    var repo domain.AuthRepository = infrastructure.NewAuthRepository()
    var tx application.Transaction = infrastructure.GetDB()
    var service application.AuthService = application.NewAuthService(repo, tx)
    var controller *userinterface.AuthController = userinterface.NewAuthController(service)

    return controller
}
```

### Constructor Injection の課題

- レイヤードアーキテクチャで userinterface 層の Controller のファクトリ関数を作ると、依存するインスタンスを多く作る必要がある
  - application 層のアプリケーションサービスが依存するリポジトリが増えると更に複雑化する
- Controller の追加やフィールドの追加に追随して Controller のファクトリ関数をメンテナンスする必要がある
- これらの課題を解決するために`google/wire`を使って Controller のファクトリ関数の依存を解決する

## 4.`google/wire`を用いた DI の実現方法

### ファクトリ関数の自動生成手順

1. 各サブモジュールのルート(`userinterface`パッケージ等と同階層)に`injection`パッケージを作成する
2. `injection`パッケージ配下に`wire.go`ファイルを作成し、ファクトリ関数を定義する（記述方法は後述）
3. `wire`コマンドを実行し、`injection`パッケージに生成される`wire_gen.go`にビルド後のファクトリ関数が誕生する（出力内容は後述）
4. `wire_gen.go`生成後にび`wire.go`を修正する場合は、`go generate`で`wire`コマンドが自動実行されるようになる

### `wire.go`の記述方法

- 例: 前述した`InitializeAuthController`を生成する

```go
//go:build wireinject
// +build wireinject

package injection

import (
    "authentication/application"
    "authentication/domain"
    "authentication/infrastructure"
    "authentication/userinterface"

    "github.com/google/wire"
)

func InitializeAuthController() *userinterface.AuthController {
    wire.Build(
        infrastructure.GetDB,
        wire.Bind(
            new(application.Transaction),
            new(*infrastructure.DB),
        ),
        infrastructure.NewAuthRepository,
        wire.Bind(
            new(domain.AuthRepository),
            new(*infrastructure.AuthRepository),
        ),
        application.NewAuthService,
        userinterface.NewAuthController,
    )

    return nil
}
```

### 生成される`wire_gen.go`

- `wire_gen.go`は以下のような形で出力される

```go
// Code generated by Wire. DO NOT EDIT.

//go:generate go run github.com/google/wire/cmd/wire
//go:build !wireinject
// +build !wireinject

package injection

import (
    "authentication/application"
    "authentication/infrastructure"
    "authentication/userinterface"
)

// Injectors from wire.go:

func InitializeAuthController() *userinterface.AuthController {
    authRepository := infrastructure.NewAuthRepository()
    db := infrastructure.GetDB()
    authService := application.NewAuthService(authRepository, db)
    authController := userinterface.NewAuthController(authService)
    return authController
}
```
